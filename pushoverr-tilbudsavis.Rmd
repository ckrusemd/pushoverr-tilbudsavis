---
title: "Tilbudsavis - ChatGPT Prompts"
author: "Christian Kruse"
date: "`r Sys.Date()`"
output: 
  bookdown::gitbook:
    css: style.css
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
options(scipen=999)
```

# Tilbudsavis - ChatGPT Prompts

```{r}

if (!require(pacman)) { install.packages("pacman") }
pacman::p_load(pushoverr,
               dplyr,
               tidyr,
               lubridate,
               scales,
               httr,
               ggplot2,
               rPref,
               jsonlite,
               DT,
               glue)

```


```{r warning=FALSE,message=FALSE,include=FALSE}
readRenviron(path = "Renviron.site")
```

```{r warning=FALSE,message=FALSE,include=FALSE}
pushoverr::set_pushover_app(token = Sys.getenv("PUSHOVER_APPKEY"))
pushoverr::set_pushover_user(user = Sys.getenv("PUSHOVER_USERKEY"))
```

```{r}

keywords = c("skyr",
             "yoghurt",
             "bilka",
             "tun",
             "cola",
             "pepsi",
             "oksekød",
             "pizza",
             "rugbrød",
             "slik",
             "pølser",
             "lego",
             "lotus",
             "vitamin",
             "legetøj",
             # "ninjago",
             "pølser",
             "switch",
             "playstation",
             "tabs",
             "ps5",
             "chokolade",
             "opbevaring",
             "tandpasta",
             "neutral",
             "slik",
             "kaffe",
             "laks"
             )

df_etilbudsavisen = do.call("rbind",lapply(keywords,function (keyword) {
  message(keyword)
  tryCatch(expr = {
  url = glue("https://etilbudsavis.dk/api/squid/v2/offers/search?query={keyword}&r_lat=55.7715601&r_lng=12.4943525&r_radius=30000&r_locale=da_DK&limit=100&offset=0")
  api_url = utils::URLencode(url)
  api_result = httr::GET(api_url)
  api_json = rawToChar(api_result$content)
  result = jsonlite::fromJSON(api_json)
  
  temp_df = result %>% 
    dplyr::select(heading,description,run_from,run_till,pricing) %>% 
    unnest_wider(pricing) %>% 
    dplyr::select(-pre_price,-currency) 
  
  dealer_dictionary = result$dealer %>% dplyr::select(name) 
  quantity_dictionary_unit = result$quantity$unit$symbol
  quantity_dictionary_size = result$quantity$size$to
  
  temp_df %>% 
    bind_cols(dealer_dictionary) %>% 
    dplyr::mutate(size=quantity_dictionary_size,
                  unit=quantity_dictionary_unit) %>% 
    dplyr::mutate(run_from=ymd(substr(run_from,start = 1,stop = 10))) %>% 
    dplyr::mutate(run_till=ymd(substr(run_till,start = 1,stop = 10))) %>% 
    filter(run_from<=Sys.Date()) %>% 
    filter(run_till>=Sys.Date()) %>% 
    # filter(!name %in% c("Harald Nyborg","Kop & Kande","Elgiganten","Lidl","Min Købmand","Imerco","Skousen","LET-KØB")) %>% 
    dplyr::mutate(name_full=name) %>% 
    dplyr::mutate(name=recode(name,
                              "føtex"="F",
                              "Netto"="N",
                              "Irma"="I",
                              "Coop365"="C",
                              "MENY"="M",
                              "SuperBrugsen"="SB",
                              "Kvickly"="K",
                              "Bilka"="B",
                              "REMA 1000"="R",
                              "Harald Nyborg"="HN",
                              "Dagli'Brugsen"="DB",
                              "SPAR"="S"),
                  keyword=keyword)
    
  },error=function(e) {
    data.frame()
  })
})) %>% 
  distinct() %>% 
  # dplyr::select(-run_from,-run_till) %>%  
  dplyr::mutate(size_converted=case_when(unit=="g"~size*1,
                                         unit=="kg"~size*1000,
                                         unit=="l"~size*1000,
                                         unit=="cl"~size*10,
                                         unit=="ml"~size*1,
                                         TRUE~as.numeric(NA))) %>% 
  dplyr::mutate(price_per_kg=price/(size_converted/1000)) %>% 
  dplyr::mutate(price_per_kg=round(price_per_kg,1)) %>% 
  unite(size,size,unit,sep = " ") 
  
  df_etilbudsavisen
```


```{r}
df_etilbudsavisen %>% DT::datatable(.,filter="top")
```

```{r}
openxlsx::write.xlsx(x = df_etilbudsavisen,file = "_book/df_etilbudsavisen.xlsx")
```

# Skyr

```{r}
df_etilbudsavisen %>% filter(keyword=="skyr") %>%  DT::datatable(.,filter="top")
```

# Oksekød

```{r}
df_etilbudsavisen %>% filter(keyword=="oksekød") %>%  DT::datatable(.,filter="top")
```

# Sodavand

```{r}
df_etilbudsavisen %>% filter(keyword %in% c("cola","pepsi")) %>%  DT::datatable(.,filter="top")
```

# Pushoverr

```{r}
pushoverr_string = df_etilbudsavisen %>% 
  filter(keyword %in% c("skyr","tun","sodavand","oksekød"),
         name_full %in% c("Coop365","Kvickly","Meny","Netto","føtex","Rema 1000","Bilka")) %>% 
  dplyr::select(name,heading,price,size) %>% 
  group_by(name) %>% 
  dplyr::mutate(label_=paste0(heading,", ",size,"/",scales::number(price,1))) %>% 
  dplyr::select(name,label_) %>% 
  dplyr::mutate(text=paste(label_,collapse="\n")) %>% 
  dplyr::select(name,text) %>% 
  distinct() %>% 
  ungroup() %>% 
  unite(name,name,text,sep = ":\n") %>% 
  pull(name) %>% 
  paste0(.,collapse="\n")
nchar(pushoverr_string)
pushoverr::pushover(pushoverr_string)
```

