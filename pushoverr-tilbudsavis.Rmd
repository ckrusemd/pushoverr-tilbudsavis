---
title: "Pushoverr eTilbudsavis"
author: "Christian Kruse"
date: "`r Sys.Date()`"
output: html_document
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
options(scipen=999)
```

# Pushoverr eTilbudsavis

```{r}

if (!require(pacman)) { install.packages("pacman") }
pacman::p_load(pushoverr,
               dplyr,
               tidyr,
               lubridate,
               scales,
               httr,
               ggplot2,
               rPref,
               jsonlite,
               glue)

```


```{r warning=FALSE,message=FALSE,include=FALSE}
readRenviron(path = "Renviron.site")
pushoverr::set_pushover_app(token = Sys.getenv("PUSHOVER_APPKEY"))
pushoverr::set_pushover_user(user = Sys.getenv("PUSHOVER_USERKEY"))
key_chatgpt = Sys.getenv("CHATGPTAPIKEY")


```

```{r}

keywords = c("skyr",
             # "yoghurt",
             "tun",
             "cola"#,
             # "oksekød",
             # "pizza",
             # "rugbrød",
             # "slik",
             # "pølser",
             # "kaffe",
             # "laks"
             )

df_etilbudsavisen = do.call("rbind",lapply(keywords,function (keyword) {
  message(keyword)
  url = glue("https://etilbudsavis.dk/api/squid/v2/offers/search?query={keyword}&r_lat=55.7715601&r_lng=12.4943525&r_radius=30000&r_locale=da_DK&limit=100&offset=0")
  api_url = utils::URLencode(url)
  api_result = httr::GET(api_url)
  api_json = rawToChar(api_result$content)
  result = jsonlite::fromJSON(api_json)
  
  temp_df = result %>% 
    dplyr::select(heading,description,run_from,run_till,pricing) %>% 
    unnest_wider(pricing) %>% 
    dplyr::select(-pre_price,-currency) 
  
  dealer_dictionary = result$dealer %>% dplyr::select(name) 
  quantity_dictionary_unit = result$quantity$unit$symbol
  quantity_dictionary_size = result$quantity$size$to
  
  temp_df %>% 
    bind_cols(dealer_dictionary) %>% 
    dplyr::mutate(size=quantity_dictionary_size,
                  unit=quantity_dictionary_unit) %>% 
    dplyr::mutate(run_from=ymd(substr(run_from,start = 1,stop = 10))) %>% 
    dplyr::mutate(run_till=ymd(substr(run_till,start = 1,stop = 10))) %>% 
    filter(run_from<=Sys.Date()) %>% 
    filter(run_till>=Sys.Date()) %>% 
    filter(!name %in% c("Harald Nyborg","Kop & Kande","Elgiganten","Lidl","Min Købmand","Imerco","Skousen","LET-KØB")) %>% 
    dplyr::mutate(name=recode(name,
                              "føtex"="F",
                              "Netto"="N",
                              "Irma"="I",
                              "Coop365"="C",
                              "MENY"="M",
                              "SuperBrugsen"="SB",
                              "Kvickly"="K",
                              "Bilka"="B",
                              "REMA 1000"="R",
                              "Harald Nyborg"="HN",
                              "Dagli'Brugsen"="DB",
                              "SPAR"="S"))
})) %>% 
  distinct() %>%
  dplyr::select(-run_from,-run_till) %>% 
  unite(size,size,unit,sep = " ")

```

# By store

```{r}
msg = df_etilbudsavisen %>% 
  # dplyr::mutate(text=glue("STORE: {name}, DESCRIPTION: {heading}, AMOUNT: {size}, PRICE: {price}")) %>% 
  dplyr::mutate(text=glue("{name}: {heading}, {price} kr.,{size}")) %>% 
  pull(text) %>% 
  paste(.,collapse="\n")
msg = glue("
           You are an expert in examining shopping deals.
           You will be provided a table of shopping offers in this format: 
           1) Store (F = Føtex, N = Netto, C = Coop365, M = Meny, SB = SuperBrugsen, K = Kvickly, B = Bilka, S = Spar), 
           2) Heading, 
           3) Price in Danish kroner, 
           4) Size. 
           
           List in bullet-point format all deals in the order of:
           1) The store, writing out the full name from the abbreviation, 
           2) Sub-bullet-points of each offer in the format of Topic: Item Name, Price, Content.  
           
           An example would be:
            Netto:
            - Skyr, 1000g, 20 kr.
            - Tun, 140g, 12 kr.
           
           Do not write any introducing or conclusion text. 
           
           The topics area:
           1) Skyr
           2) Tuna
           3) Sodavand
           
           {msg}")
msg
```

# API

```{r}

df_query = httr::POST( 
    url = "https://api.openai.com/v1/chat/completions", 
    httr::add_headers(
      `Content-Type` = "application/json", 
      `Authorization` = glue("Bearer {key_chatgpt}")
    ),
    body = list(
      model = "gpt-3.5-turbo",
      messages = list(
        list(role="system",content="You are a shopping assistant planning today's grocery purchases."),
        list(role="user",content=msg)
      ),
      max_tokens = 4097-nchar(msg)
    ),encode="json"
  )

  jsonRespText = content(df_query,as="text",encoding = "UTF-8") 
  jsonDataframe = fromJSON(jsonRespText)
  response_message = glue("{jsonDataframe$choices$message$content}\n\n\n")
  cat(response_message)
```


```{r}
message(nchar(response_message))
```


```{r}
message(response_message)
```


```{r}
pushoverr::pushover(message = substr(response_message,1,1024))
```


